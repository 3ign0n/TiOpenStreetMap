/**
 * This file was auto-generated by the Titanium Module SDK helper for Android
 * Appcelerator Titanium Mobile
 * Copyright (c) 2009-2010 by Appcelerator, Inc. All Rights Reserved.
 * Licensed under the terms of the Apache Public License
 * Please see the LICENSE included with this distribution for details.
 *
 */
package org.appcelerator.openstreetmap;

import org.andnav.osm.util.TypeConverter;
import org.andnav.osm.views.OpenStreetMapView;
import org.andnav.osm.views.controller.OpenStreetMapViewController;
import org.andnav.osm.views.util.OpenStreetMapRendererInfo;
import org.andnav.osm.views.util.constants.OpenStreetMapViewConstants;
import org.appcelerator.kroll.KrollDict;
import org.appcelerator.kroll.KrollProxy;
import org.appcelerator.kroll.annotations.Kroll;

import org.appcelerator.titanium.TiC;
import org.appcelerator.titanium.TiContext;
import org.appcelerator.titanium.util.Log;
import org.appcelerator.titanium.util.TiConfig;
import org.appcelerator.titanium.proxy.TiViewProxy;
import org.appcelerator.titanium.view.TiUIView;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.res.Resources;
import android.hardware.Sensor;
import android.hardware.SensorManager;
import android.location.Location;
import android.location.LocationManager;
import android.os.Handler;
import android.os.Message;
import android.os.PowerManager;
import android.preference.PreferenceManager;
import android.view.Gravity;
import android.view.KeyEvent;
import android.view.View;
import android.view.Window;
import android.view.WindowManager;
import android.view.View.OnClickListener;
import android.view.View.OnLongClickListener;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;
import android.widget.RelativeLayout.LayoutParams;
//import android.util.Log;

import com.robert.maps.MainMapActivity;
import com.robert.maps.R;
//import com.robert.maps.MainMapActivity.MainActivityCallbackHandler;
import com.robert.maps.kml.PoiManager;
import com.robert.maps.overlays.CurrentTrackOverlay;
import com.robert.maps.overlays.MyLocationOverlay;
import com.robert.maps.overlays.PoiOverlay;
import com.robert.maps.overlays.SearchResultOverlay;
import com.robert.maps.overlays.TrackOverlay;
import com.robert.maps.overlays.YandexTrafficOverlay;
import com.robert.maps.utils.CompassView;
import com.robert.maps.utils.CrashReportHandler;
import com.robert.maps.utils.ScaleBarDrawable;
import com.robert.maps.utils.Ut;

import com.robert.maps.kml.PoiActivity;
import com.robert.maps.kml.PoiListActivity;
import com.robert.maps.kml.PoiManager;
import com.robert.maps.kml.PoiPoint;
import com.robert.maps.kml.Track;
import com.robert.maps.kml.TrackListActivity;
import com.robert.maps.kml.XMLparser.PredefMapsParser;
import com.robert.maps.overlays.CurrentTrackOverlay;
import com.robert.maps.overlays.MyLocationOverlay;
import com.robert.maps.overlays.PoiOverlay;
import com.robert.maps.overlays.SearchResultOverlay;
import com.robert.maps.overlays.TrackOverlay;
import com.robert.maps.overlays.YandexTrafficOverlay;
import com.robert.maps.utils.CompassView;
import com.robert.maps.utils.CrashReportHandler;
import com.robert.maps.utils.ScaleBarDrawable;
import com.robert.maps.utils.SearchSuggestionsProvider;
import com.robert.maps.utils.Ut;

public class TiMapView extends TiUIView
{
	// Standard Debugging variables
	private static final String LCAT = "OpenStreetMapView";
	private static final boolean DBG = true;//TiConfig.LOGD;
	
	private Activity mParentActivity = null;

	private OpenStreetMapView mOsmv; //, mOsmvMinimap;
	private MyLocationOverlay mMyLocationOverlay;
	private PoiOverlay mPoiOverlay;
	private CurrentTrackOverlay mCurrentTrackOverlay;
	private TrackOverlay mTrackOverlay;
	private SearchResultOverlay mSearchResultOverlay;

	private PowerManager.WakeLock myWakeLock;
	private boolean mFullScreen;
	private boolean mShowTitle;
	private String mStatusListener = "";
	private boolean mAutoFollow = true;
	private ImageView ivAutoFollow;
	private CompassView mCompassView;
	private SensorManager mOrientationSensorManager;
	private boolean mCompassEnabled;
	private boolean mDrivingDirectionUp;
	private boolean mNorthDirectionUp;
	private int mScreenOrientation;
	private float mLastSpeed, mLastBearing;
	private PoiManager mPoiManager;
	private String ACTION_SHOW_POINTS = "com.robert.maps.action.SHOW_POINTS";
	
	// Constructor
	public TiMapView(final TiViewProxy proxy) {
		super(proxy);
		
		Log.d(LCAT, "#########TiConfig.LOGD=" + TiConfig.LOGD);

		mParentActivity = ((TiContext) proxy.getTiContext()).getActivity();
		if(OpenStreetMapViewConstants.DEBUGMODE)
    		android.os.Debug.startMethodTracing("lsd");
		if (DBG) Log.d(LCAT, "OpenStreetMapView");
        if(!OpenStreetMapViewConstants.DEBUGMODE)
        	CrashReportHandler.attach(mParentActivity);
		
        CheckNeedDataUpdate();
        
        mPoiManager = new PoiManager(proxy.getContext());
        mOrientationSensorManager = (SensorManager)mParentActivity.getSystemService(Context.SENSOR_SERVICE);
       	final SharedPreferences pref = PreferenceManager.getDefaultSharedPreferences(mParentActivity);
		
		final RelativeLayout rl = new RelativeLayout(proxy.getContext());
        OpenStreetMapRendererInfo RendererInfo = new OpenStreetMapRendererInfo(mParentActivity.getResources(), "");
        RendererInfo.URL_BUILDER_TYPE = 0;
        this.mOsmv = new OpenStreetMapView(proxy.getContext(), RendererInfo);
//        this.mOsmv.setMainActivityCallbackHandler(mCallbackHandler);
        rl.addView(this.mOsmv, new RelativeLayout.LayoutParams(LayoutParams.FILL_PARENT, LayoutParams.FILL_PARENT));
        mParentActivity.registerForContextMenu(mOsmv);
       
        /* SingleLocation-Overlay */
        {
	        /* Create a static Overlay showing a single location. (Gets updated in onLocationChanged(Location loc)! */
        	if(RendererInfo.YANDEX_TRAFFIC_ON == 1)
        		this.mOsmv.getOverlays().add(new YandexTrafficOverlay(proxy.getContext(), this.mOsmv));

	        this.mMyLocationOverlay = new MyLocationOverlay(proxy.getContext());
	        this.mOsmv.getOverlays().add(mMyLocationOverlay);
	        
// [TODO] null pointer exception in NinePatch
//	        this.mSearchResultOverlay = new SearchResultOverlay(proxy.getContext());
//	        this.mOsmv.getOverlays().add(mSearchResultOverlay);
        }

        /* Itemized Overlay */
		{
			this.mTrackOverlay = new TrackOverlay(proxy.getContext(), mPoiManager);
			this.mOsmv.getOverlays().add(this.mTrackOverlay);

			this.mCurrentTrackOverlay = new CurrentTrackOverlay(proxy.getContext(), mPoiManager, mOsmv);
			this.mOsmv.getOverlays().add(this.mCurrentTrackOverlay);

// [TODO] null pointer exception in NinePatch
//			this.mPoiOverlay = new PoiOverlay(proxy.getContext(), mPoiManager, null, pref.getBoolean("pref_hidepoi", false));
//			this.mOsmv.getOverlays().add(this.mPoiOverlay);
		}
		
		{
			// compass, autoFlow, zoomControl
		}

		mDrivingDirectionUp = pref.getBoolean("pref_drivingdirectionup", true);
		mNorthDirectionUp = pref.getBoolean("pref_northdirectionup", true);

//		mScreenOrientation = Integer.parseInt(pref.getString("pref_screen_orientation", "-1"));
//		this.setRequestedOrientation(mScreenOrientation);
//
//     	mFullScreen = pref.getBoolean("pref_showstatusbar", true);
//		if (mFullScreen)
//			getWindow().setFlags(WindowManager.LayoutParams.FLAG_FORCE_NOT_FULLSCREEN,
//					WindowManager.LayoutParams.FLAG_FORCE_NOT_FULLSCREEN);
//		else
//			getWindow()
//					.setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);
//
//		mShowTitle = pref.getBoolean("pref_showtitle", true);
//		if (mShowTitle)
//	        requestWindowFeature(Window.FEATURE_CUSTOM_TITLE);
//		else
//			requestWindowFeature(Window.FEATURE_NO_TITLE);
//
//        this.setContentView(rl);
//
//        if(mShowTitle)
//	        getWindow().setFeatureInt(Window.FEATURE_CUSTOM_TITLE, R.layout.main_title);

		restoreUIState();
        
        setNativeView(rl);
    }
	
	private void CheckNeedDataUpdate() {
		SharedPreferences settings = mParentActivity.getPreferences(Activity.MODE_PRIVATE);
//		final int versionDataUpdate = settings.getInt("versionDataUpdate", 0);
//		Ut.dd("versionDataUpdate="+versionDataUpdate);
//
//		if(versionDataUpdate < 3){
//			Ut.dd("Upgrade app data to v.3");
//		}

		SharedPreferences uiState = mParentActivity.getPreferences(0);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          		SharedPreferences.Editor editor = uiState.edit();
		editor.putInt("versionDataUpdate", 3);
		editor.commit();
	}

//	[TODO] locationUpdate
//	private void setLastKnownLocation() {
//		final LocationManager lm = (LocationManager) getSystemService(Context.LOCATION_SERVICE);
//		final Location loc1 = lm.getLastKnownLocation("gps");
//		final Location loc2 = lm.getLastKnownLocation("network");
//
//		boolean boolGpsEnabled = lm.isProviderEnabled(GPS);
//		boolean boolNetworkEnabled = lm.isProviderEnabled(NETWORK);
//		String str = "";
//		Location loc = null;
//
//		if(loc1 == null && loc2 != null)
//			loc = loc2;
//		else if (loc1 != null && loc2 == null)
//			loc = loc1;
//		else if (loc1 == null && loc2 == null)
//			loc = null;
//		else
//			loc = loc1.getTime() > loc2.getTime() ? loc1 : loc2;
//
//		if(boolGpsEnabled){}
//		else if(boolNetworkEnabled)
//			str = getString(R.string.message_gpsdisabled);
//		else if(loc == null)
//			str = getString(R.string.message_locationunavailable);
//		else
//			str = getString(R.string.message_lastknownlocation);
//
//		if(str.length() > 0)
//			Toast.makeText(this, str, Toast.LENGTH_LONG).show();
//
//		if (loc != null)
//			this.mOsmv
//					.getController()
//					.animateTo(
//							TypeConverter.locationToGeoPoint(loc),
//							OpenStreetMapViewController.AnimationType.MIDDLEPEAKSPEED,
//							OpenStreetMapViewController.ANIMATION_SMOOTHNESS_HIGH,
//							OpenStreetMapViewController.ANIMATION_DURATION_DEFAULT);
//	}
	private OpenStreetMapRendererInfo getRendererInfo(final Resources aRes, final SharedPreferences aPref, final String aName){
		OpenStreetMapRendererInfo RendererInfo = new OpenStreetMapRendererInfo(aRes, aName);
		RendererInfo.LoadFromResources(aName, PreferenceManager.getDefaultSharedPreferences(getProxy().getTiContext().getActivity()));


		return RendererInfo;
	}
	
	private void setTitle(Activity activity){
		final TextView leftText = (TextView) activity.findViewById(R.id.left_text);
		if(leftText != null)
			leftText.setText(mOsmv.getRenderer().NAME);

		final TextView rightText = (TextView) activity.findViewById(R.id.right_text);
		if(rightText != null){
			rightText.setText(mStatusListener + " " + (1+mOsmv.getZoomLevel()));
		}
	}
	
	private void restoreUIState() {
		SharedPreferences settings = mParentActivity.getPreferences(Activity.MODE_PRIVATE);

		OpenStreetMapRendererInfo RendererInfo = getRendererInfo(mParentActivity.getResources(), settings, settings.getString("MapName", "mapnik"));
		android.util.Log.d("#####restoreUIState", "TILE_SOURCE_TYPE=" + RendererInfo.TILE_SOURCE_TYPE + ", URL_BUILDER_TYPE=" + RendererInfo.URL_BUILDER_TYPE + ", BASEURL=" +RendererInfo.BASEURL);
		if(!mOsmv.setRenderer(RendererInfo))
			mOsmv.setRenderer(getRendererInfo(mParentActivity.getResources(), settings, "mapnik"));

		this.mOsmv.getOverlays().clear();
		if(RendererInfo.YANDEX_TRAFFIC_ON == 1){
       		this.mOsmv.getOverlays().add(new YandexTrafficOverlay(mParentActivity, this.mOsmv));
		}
        if(mTrackOverlay != null)
        	this.mOsmv.getOverlays().add(mTrackOverlay);
        if(mCurrentTrackOverlay != null)
        	this.mOsmv.getOverlays().add(mCurrentTrackOverlay);
        if(mPoiOverlay != null)
        	this.mOsmv.getOverlays().add(mPoiOverlay);
        this.mOsmv.getOverlays().add(mMyLocationOverlay);
        this.mOsmv.getOverlays().add(mSearchResultOverlay);

		mOsmv.setZoomLevel(settings.getInt("ZoomLevel", 0));
		mOsmv.setMapCenter(settings.getInt("Latitude", 0), settings.getInt("Longitude", 0));

//		mCompassEnabled = settings.getBoolean("CompassEnabled", false);
//		mCompassView.setVisibility(mCompassEnabled ? View.VISIBLE : View.INVISIBLE);
//
//		mAutoFollow = settings.getBoolean("AutoFollow", true);
//		ivAutoFollow.setVisibility(mAutoFollow ? ImageView.INVISIBLE : View.VISIBLE);

		setTitle(mParentActivity);

		if(mPoiOverlay != null)
			mPoiOverlay.setTapIndex(settings.getInt("curShowPoiId", -1));

//		mSearchResultOverlay.fromPref(settings);

		if(settings.getString("error", "").length() > 0){
//			activity.showDialog(R.id.error);
			Log.e(LCAT, mParentActivity.getString(R.id.error));
		}

//		if(!settings.getString("app_version", "").equalsIgnoreCase(Ut.getAppVersion(activity))) {
//			activity.showDialog(R.id.whatsnew);
//		}

		if (settings.getBoolean("add_yandex_bookmark", true))
			if (mParentActivity.getResources().getConfiguration().locale.toString()
					.equalsIgnoreCase("ru_RU")) {
				SharedPreferences uiState = mParentActivity.getPreferences(0);
				SharedPreferences.Editor editor = uiState.edit();
				editor.putBoolean("add_yandex_bookmark", false);
				editor.commit();

//				Message msg = Message.obtain(mCallbackHandler,
//						R.id.add_yandex_bookmark);
//				mCallbackHandler.sendMessageDelayed(msg, 2000);
			}
	}
	
	private void storeMiscSettings() {
		SharedPreferences uiState = mParentActivity.getPreferences(0);
		SharedPreferences.Editor editor = uiState.edit();
		editor.putString("MapName", mOsmv.getRenderer().ID);
		editor.putInt("Latitude", mOsmv.getMapCenterLatitudeE6());
		editor.putInt("Longitude", mOsmv.getMapCenterLongitudeE6());
		editor.putInt("ZoomLevel", mOsmv.getZoomLevel());
		editor.putBoolean("CompassEnabled", mCompassEnabled);
		editor.putBoolean("AutoFollow", mAutoFollow);
		editor.putString("app_version", Ut.getAppVersion(mParentActivity));
		if(mPoiOverlay != null)
			editor.putInt("curShowPoiId", mPoiOverlay.getTapIndex());
		mSearchResultOverlay.toPref(editor);
		editor.commit();
		Log.d(LCAT, "#####setupMisc" +editor.toString());

		if (myWakeLock != null) {
			myWakeLock.release();
		}
// [TODO]
//		mOrientationSensorManager.unregisterListener(mListener);
	}

//	protected void () {
//    	SharedPreferences pref = PreferenceManager.getDefaultSharedPreferences(mParentActivity);

//		if (pref.getBoolean("pref_keepscreenon", true)) {
//			myWakeLock = ((PowerManager) mParentActivity.getSystemService(mParentActivity.POWER_SERVICE)).newWakeLock(
//					PowerManager.SCREEN_BRIGHT_WAKE_LOCK | PowerManager.ON_AFTER_RELEASE, "RMaps");
//			myWakeLock.acquire();
//		} else {
//			myWakeLock = null;
//		}

// [TODO]
//		if(mCompassEnabled)
//			mOrientationSensorManager.registerListener(mListener, mOrientationSensorManager
//				.getDefaultSensor(Sensor.TYPE_ORIENTATION), SensorManager.SENSOR_DELAY_UI);
//
//		if(mTrackOverlay != null)
//			mTrackOverlay.setStopDraw(false);
//	}
}